<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Espace communautaire transparent pour la co-construction des engagements de la table ronde.">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com;">
  <title>Journal Communautaire – Suivi Table Ronde</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --background: #f6f5f1;
      --surface: #ffffff;
      --primary: #4a6d7c;
      --primary-strong: #2f4a52;
      --accent: #c97b84;
      --text: #2b2b2b;
      --text-muted: #5a5a5a;
      --border: #dcd7c9;
      --radius: 12px;
      --shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
      --transition: 0.25s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 12px 64px;
      font-family: 'Roboto', sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(201, 123, 132, 0.18), transparent 50%),
                  radial-gradient(circle at 80% 0%, rgba(74, 109, 124, 0.18), transparent 45%),
                  var(--background);
      color: var(--text);
    }

    header {
      max-width: 960px;
      margin: 0 auto 32px;
      padding: 32px;
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    header h1 {
      margin-top: 0;
      font-size: 2.4rem;
      color: var(--primary-strong);
    }

    header p {
      margin-bottom: 0;
      color: var(--text-muted);
      line-height: 1.6;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    .panel {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
    }

    .panel h2 {
      margin-top: 0;
      color: var(--primary-strong);
      font-size: 1.6rem;
    }

    .panel p {
      color: var(--text-muted);
      line-height: 1.6;
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--primary-strong);
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fbfbfa;
      color: var(--text);
      font-size: 1rem;
      transition: border var(--transition), box-shadow var(--transition);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(74, 109, 124, 0.15);
    }

    fieldset {
      border: none;
      padding: 0;
      margin: 0;
    }

    legend {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--primary);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-primary:hover,
    .btn-primary:focus {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(74, 109, 124, 0.25);
    }

    .btn-secondary {
      background: transparent;
      color: var(--primary-strong);
      border: 1px solid var(--primary-strong);
    }

    .btn-secondary:hover,
    .btn-secondary:focus {
      background: rgba(74, 109, 124, 0.1);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
    }

    .feedback {
      margin-top: 16px;
      font-weight: 500;
      color: var(--accent);
    }

    .entry-list {
      display: grid;
      gap: 16px;
    }

    .entry-card {
      border-radius: 16px;
      border: 1px solid rgba(74, 109, 124, 0.08);
      padding: 20px;
      background: linear-gradient(135deg, rgba(74, 109, 124, 0.04), rgba(201, 123, 132, 0.04));
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .entry-card:hover,
    .entry-card:focus-within {
      transform: translateY(-2px);
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.12);
    }

    .entry-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      background: rgba(201, 123, 132, 0.18);
      color: var(--primary-strong);
      border-radius: 999px;
      font-size: 0.85rem;
    }

    .empty-state {
      text-align: center;
      padding: 32px;
      color: var(--text-muted);
      border: 2px dashed rgba(74, 109, 124, 0.18);
      border-radius: var(--radius);
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    .filter-bar label {
      margin-bottom: 0;
    }

    .filter-bar input[type="search"] {
      flex: 1 1 220px;
    }

    .counter {
      font-weight: 600;
      color: var(--primary-strong);
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    @media (max-width: 680px) {
      header {
        padding: 24px;
      }

      header h1 {
        font-size: 2rem;
      }

      .actions {
        flex-direction: column;
        align-items: stretch;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Journal communautaire</h1>
    <p>
      Cet espace est conçu pour rendre visibles les décisions, engagements et demandes de soutien de la table ronde. Chaque contribution est stockée localement dans votre navigateur : vous restez propriétaire des données et pouvez les partager librement avec votre collectif.
    </p>
  </header>

  <main>
    <section class="panel" aria-labelledby="participation-title">
      <h2 id="participation-title">Proposer une contribution</h2>
      <p>
        Décrivez la situation, les engagements pris et les personnes concernées. Plus les informations sont claires, plus il sera simple pour la communauté d'agir.
      </p>
      <form id="entryForm">
        <fieldset>
          <legend>Informations essentielles</legend>
          <label for="entryTitle">Titre de la contribution *</label>
          <input id="entryTitle" name="title" type="text" maxlength="120" required autocomplete="off">

          <label for="entrySummary">Contexte et décision *</label>
          <textarea id="entrySummary" name="summary" maxlength="2000" required></textarea>

          <label for="entryCommitments">Engagements et prochaines étapes *</label>
          <textarea id="entryCommitments" name="commitments" maxlength="2000" required></textarea>

          <div class="grid-two">
            <div>
              <label for="entryParticipants">Personnes impliquées</label>
              <input id="entryParticipants" name="participants" type="text" maxlength="200">
            </div>
            <div>
              <label for="entryDecisionType">Nature de la décision</label>
              <select id="entryDecisionType" name="decisionType">
                <option value="">Sélectionnez une option</option>
                <option value="consensus">Consensus</option>
                <option value="consultation">Consultation</option>
                <option value="initiative">Initiative personnelle</option>
                <option value="veille">Veille / À explorer</option>
              </select>
            </div>
          </div>

          <label for="entryTags">Mots-clés (séparés par des virgules)</label>
          <input id="entryTags" name="tags" type="text" maxlength="200" autocomplete="off" placeholder="ex : transparence, budget, soutien">
        </fieldset>

        <div class="actions">
          <button type="submit" class="btn-primary">Publier dans le journal</button>
          <button type="button" id="saveDraft" class="btn-secondary">Sauvegarder le brouillon</button>
          <button type="button" id="clearDraft" class="btn-secondary">Effacer le brouillon</button>
        </div>
      </form>
      <p id="formFeedback" class="feedback" role="status" aria-live="polite"></p>
    </section>

    <section class="panel" aria-labelledby="transparency-title">
      <div class="filter-bar">
        <h2 id="transparency-title">Journal transparent</h2>
        <label for="tagFilter">Filtrer par mot-clé</label>
        <select id="tagFilter">
          <option value="">Tous les mots-clés</option>
        </select>
        <label for="searchEntries" class="sr-only">Rechercher dans le journal</label>
        <input id="searchEntries" type="search" placeholder="Rechercher une décision ou un engagement">
      </div>
      <p class="counter" id="entriesCounter">0 contribution documentée</p>
      <div id="entriesList" class="entry-list" aria-live="polite"></div>
      <div id="emptyState" class="empty-state" hidden>
        <p>Le journal est vide pour le moment. Ajoutez votre première contribution pour lancer la discussion.</p>
      </div>
      <div class="actions">
        <button type="button" id="exportEntries" class="btn-secondary">Exporter le journal (.json)</button>
        <button type="button" id="clearEntries" class="btn-secondary">Réinitialiser le journal</button>
      </div>
      <p class="feedback" id="exportFeedback" role="status" aria-live="polite"></p>
    </section>

    <section class="panel" aria-labelledby="norms-title">
      <h2 id="norms-title">Cadre de contribution partagé</h2>
      <p>
        • Toute personne peut proposer une action ou une décision.<br>
        • Les engagements sont co-validés en public et peuvent être amendés par les participant·es.<br>
        • Les désaccords sont notés, pas effacés : précisez les questions en suspens pour inviter à l'échange.<br>
        • Vous pouvez exporter ce journal et le partager avec un outil collectif de votre choix.
      </p>
    </section>
  </main>

  <script src="js/communityLog.js"></script>
  <script>
    (function () {
      'use strict';

      const decisionLabels = {
        consensus: 'Consensus',
        consultation: 'Consultation',
        initiative: 'Initiative personnelle',
        veille: 'Veille / À explorer',
      };

      const form = document.getElementById('entryForm');
      const formFeedback = document.getElementById('formFeedback');
      const entriesList = document.getElementById('entriesList');
      const emptyState = document.getElementById('emptyState');
      const entriesCounter = document.getElementById('entriesCounter');
      const tagFilter = document.getElementById('tagFilter');
      const searchEntries = document.getElementById('searchEntries');
      const exportButton = document.getElementById('exportEntries');
      const clearButton = document.getElementById('clearEntries');
      const exportFeedback = document.getElementById('exportFeedback');
      const saveDraft = document.getElementById('saveDraft');
      const clearDraft = document.getElementById('clearDraft');
      const draftKey = 'communityLogDraft';

      function showFeedback(element, message, timeout = 5000) {
        element.textContent = message;
        if (timeout > 0) {
          setTimeout(() => {
            if (element.textContent === message) {
              element.textContent = '';
            }
          }, timeout);
        }
      }

      function getFormData() {
        const data = new FormData(form);
        return {
          title: data.get('title') || '',
          summary: data.get('summary') || '',
          commitments: data.get('commitments') || '',
          participants: data.get('participants') || '',
          decisionType: data.get('decisionType') || '',
          tags: data.get('tags') || '',
        };
      }

      function renderEntries(entries) {
        entriesList.innerHTML = '';

        if (!entries.length) {
          emptyState.hidden = false;
          entriesCounter.textContent = '0 contribution documentée';
          return;
        }

        emptyState.hidden = true;
        entriesCounter.textContent = entries.length === 1
          ? '1 contribution documentée'
          : `${entries.length} contributions documentées`;

        entries.forEach((entry) => {
          const article = document.createElement('article');
          article.className = 'entry-card';
          article.setAttribute('tabindex', '0');

          const meta = document.createElement('div');
          meta.className = 'entry-meta';
          const date = new Date(entry.createdAt);
          const dateTime = document.createElement('time');
          dateTime.dateTime = entry.createdAt;
          dateTime.textContent = date.toLocaleString('fr-FR', {
            dateStyle: 'medium',
            timeStyle: 'short',
          });
          meta.appendChild(dateTime);

          if (entry.decisionType) {
            const decision = document.createElement('span');
            decision.className = 'tag';
            decision.textContent = decisionLabels[entry.decisionType] || entry.decisionType;
            meta.appendChild(decision);
          }

          if (entry.participants) {
            const participants = document.createElement('span');
            participants.textContent = `Impliqué·es : ${entry.participants}`;
            meta.appendChild(participants);
          }

          const heading = document.createElement('h3');
          heading.textContent = entry.title;

          const summary = document.createElement('p');
          summary.textContent = entry.summary;

          const commitments = document.createElement('p');
          commitments.textContent = `Engagements : ${entry.commitments}`;

          const tagsContainer = document.createElement('div');
          tagsContainer.className = 'entry-meta';
          entry.tags.forEach((tag) => {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag';
            tagElement.textContent = tag;
            tagsContainer.appendChild(tagElement);
          });

          const removeButton = document.createElement('button');
          removeButton.type = 'button';
          removeButton.className = 'btn-secondary';
          removeButton.textContent = 'Retirer cette note';
          removeButton.addEventListener('click', () => {
            if (confirm('Voulez-vous retirer cette contribution du journal ?')) {
              const updated = CommunityLog.removeEntry(entry.id);
              refreshEntries(updated);
              showFeedback(exportFeedback, 'Contribution retirée. Vous pouvez toujours la republier.');
            }
          });

          article.appendChild(meta);
          article.appendChild(heading);
          article.appendChild(summary);
          article.appendChild(commitments);
          if (entry.tags.length) {
            article.appendChild(tagsContainer);
          }
          article.appendChild(removeButton);

          entriesList.appendChild(article);
        });
      }

      function refreshEntries(entries) {
        const baseEntries = entries
          ? CommunityLog.sortEntries(entries)
          : CommunityLog.sortEntries(CommunityLog.loadEntries());

        const filtered = CommunityLog.filterEntries(baseEntries, {
          tag: tagFilter.value,
          search: searchEntries.value,
        });
        renderEntries(filtered);
        updateTagFilter(baseEntries);
      }

      function updateTagFilter(entries) {
        const currentValue = tagFilter.value;
        const tags = CommunityLog.uniqueTags(entries);
        tagFilter.innerHTML = '<option value="">Tous les mots-clés</option>';
        tags.forEach((tag) => {
          const option = document.createElement('option');
          option.value = tag;
          option.textContent = decisionLabels[tag] || tag;
          tagFilter.appendChild(option);
        });
        if (tags.includes(currentValue)) {
          tagFilter.value = currentValue;
        }
      }

      function exportEntriesToFile(entries) {
        const blob = new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'journal-communautaire.json';
        link.click();
        URL.revokeObjectURL(url);
      }

      function saveDraftData() {
        const data = getFormData();
        localStorage.setItem(draftKey, JSON.stringify(data));
        showFeedback(formFeedback, 'Brouillon sauvegardé dans ce navigateur.');
      }

      function loadDraftData() {
        const raw = localStorage.getItem(draftKey);
        if (!raw) return;
        try {
          const data = JSON.parse(raw);
          Object.entries(data).forEach(([key, value]) => {
            const field = form.elements.namedItem(key);
            if (field) {
              field.value = value;
            }
          });
          showFeedback(formFeedback, 'Brouillon chargé. Vous pouvez reprendre votre rédaction.', 4000);
        } catch (error) {
          console.warn('Brouillon illisible :', error);
        }
      }

      function clearDraftData() {
        localStorage.removeItem(draftKey);
        showFeedback(formFeedback, 'Brouillon effacé.');
      }

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const data = getFormData();
        const validation = CommunityLog.validateEntry(data);

        if (!validation.valid) {
          showFeedback(formFeedback, validation.errors.join(' '), 6000);
          return;
        }

        try {
          const entry = CommunityLog.createEntry(data);
          const entries = CommunityLog.addEntry(entry);
          form.reset();
          clearDraftData();
          refreshEntries(entries);
          showFeedback(formFeedback, 'Contribution ajoutée au journal. Merci pour votre transparence !');
        } catch (error) {
          console.error(error);
          const details = Array.isArray(error.details) ? error.details.join(' ') : '';
          showFeedback(formFeedback, `Impossible d'enregistrer la contribution. ${details}`.trim(), 6000);
        }
      });

      tagFilter.addEventListener('change', () => refreshEntries());
      searchEntries.addEventListener('input', () => refreshEntries());

      exportButton.addEventListener('click', () => {
        const entries = CommunityLog.loadEntries();
        if (!entries.length) {
          showFeedback(exportFeedback, 'Le journal est vide : ajoutez une contribution avant d’exporter.');
          return;
        }
        exportEntriesToFile(entries);
        showFeedback(exportFeedback, 'Fichier exporté. Partagez-le avec votre collectif pour renforcer la transparence.');
      });

      clearButton.addEventListener('click', () => {
        if (confirm('Cette action efface toutes les contributions de ce navigateur. Continuer ?')) {
          CommunityLog.persistEntries([]);
          refreshEntries([]);
          showFeedback(exportFeedback, 'Journal réinitialisé. Les décisions restent documentées si vous avez exporté le fichier.');
        }
      });

      saveDraft.addEventListener('click', saveDraftData);
      clearDraft.addEventListener('click', () => {
        form.reset();
        clearDraftData();
      });

      window.addEventListener('beforeunload', () => {
        const data = getFormData();
        if (data.title || data.summary || data.commitments) {
          saveDraftData();
        }
      });

      loadDraftData();
      refreshEntries();
    })();
  </script>
</body>
</html>
